#!/usr/bin/env bash
# theme — unified color management for kitty, neovim, zellij
# Usage:
#   theme                       — show current theme + help
#   theme sync                  — apply palette to all configs
#   theme set <name>            — set Gogh theme by name
#   theme search <query>        — search Gogh themes (fuzzy)
#   theme list                  — list all Gogh themes
#   theme save <name>            — save current palette as custom theme
#   theme remove <name>          — remove custom theme
#   theme import [file|url]     — import theme (kitty/Xresources/clipboard)
#   theme update                — update Gogh themes cache
#   theme current               — show current palette

PALETTE="$HOME/.config/theme/palette.conf"
GOGH_CACHE="$HOME/.config/theme/gogh-themes.json"
GOGH_URL="https://raw.githubusercontent.com/Gogh-Co/Gogh/master/data/themes.json"
CUSTOM_THEMES="$HOME/.config/theme/custom-themes.json"
BACKUP_DIR="$HOME/.config/theme/backup"
ANIMATIONS_CONF="$HOME/.config/hypr/UserConfigs/UserAnimations.conf"
DEFAULT_ANIM="$HOME/.config/hypr/animations/00-default.conf"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
BOLD='\033[1m'
DIM='\033[2m'
RESET='\033[0m'

# --- Ensure Gogh cache exists ---
ensure_cache() {
  if [[ ! -f "$GOGH_CACHE" ]]; then
    echo -e "${DIM}Downloading Gogh themes...${RESET}"
    mkdir -p "$(dirname "$GOGH_CACHE")"
    curl -sL "$GOGH_URL" -o "$GOGH_CACHE" || { echo -e "${RED}Download failed${RESET}"; exit 1; }
    local count
    count=$(python3 -c "import json; print(len(json.load(open('$GOGH_CACHE'))))" 2>/dev/null)
    echo -e "${GREEN}Cached $count themes${RESET}"
  fi
}

# --- Update cache ---
cmd_update() {
  echo "Updating Gogh themes cache..."
  rm -f "$GOGH_CACHE"
  ensure_cache
}

# --- List all themes ---
cmd_list() {
  local filter="${1:-}"
  ensure_cache
  python3 << PYEOF
import json

def luminance(hex_color):
    hex_color = hex_color.lstrip('#')
    if len(hex_color) != 6: return 128
    r, g, b = int(hex_color[0:2], 16), int(hex_color[2:4], 16), int(hex_color[4:6], 16)
    return 0.299 * r + 0.587 * g + 0.114 * b

def is_dark(t):
    return luminance(t.get('background', '#808080')) < 128

import os
filter_mode = "${filter}".lower()
themes = json.load(open("$GOGH_CACHE"))
custom = []
custom_path = "$CUSTOM_THEMES"
if os.path.exists(custom_path):
    custom = json.load(open(custom_path))
shown = 0

if custom:
    for t in custom:
        dark = is_dark(t)
        if filter_mode == "dark" and not dark: continue
        if filter_mode == "light" and dark: continue
        bg = t.get('background', '')
        tag = "\033[2mdark\033[0m" if dark else "\033[33mlight\033[0m"
        print(f'    \033[35m*\033[0m {t["name"]}  [{tag}]  \033[2m{bg}\033[0m')
        shown += 1

for i, t in enumerate(themes, 1):
    dark = is_dark(t)
    if filter_mode == "dark" and not dark: continue
    if filter_mode == "light" and dark: continue
    bg = t.get('background', '')
    tag = "\033[2mdark\033[0m" if dark else "\033[33mlight\033[0m"
    print(f'  {i:3d}. {t["name"]}  [{tag}]  \033[2m{bg}\033[0m')
    shown += 1

label = f" ({filter_mode})" if filter_mode in ("dark", "light") else ""
print(f'\n  Total: {shown} themes{label}')
PYEOF
}

# --- Search themes ---
cmd_search() {
  # Parse --dark/--light flags
  local filter="" query=""
  for arg in "$@"; do
    case "$arg" in
      --dark)  filter="dark" ;;
      --light) filter="light" ;;
      *)       query="$arg" ;;
    esac
  done
  if [[ -z "$query" && -z "$filter" ]]; then
    echo -e "${RED}Usage: theme search <query> [--dark|--light]${RESET}"
    exit 1
  fi
  ensure_cache
  python3 << PYEOF
import json, sys

def luminance(hex_color):
    hex_color = hex_color.lstrip('#')
    if len(hex_color) != 6: return 128
    r, g, b = int(hex_color[0:2], 16), int(hex_color[2:4], 16), int(hex_color[4:6], 16)
    return 0.299 * r + 0.587 * g + 0.114 * b

def is_dark(t):
    return luminance(t.get('background', '#808080')) < 128

import os
query = """${query}""".lower()
filter_mode = "${filter}"
themes = json.load(open("$GOGH_CACHE"))

# Load custom themes
custom = []
custom_path = "$CUSTOM_THEMES"
if os.path.exists(custom_path):
    custom = json.load(open(custom_path))

all_themes = [(t, True) for t in custom] + [(t, False) for t in themes]
matches = []

for t, is_custom in all_themes:
    # Apply dark/light filter
    dark = is_dark(t)
    if filter_mode == "dark" and not dark: continue
    if filter_mode == "light" and dark: continue
    # Apply name filter (if query given)
    if query and query not in t["name"].lower(): continue
    matches.append((t, is_custom))

if not matches:
    label = query or filter_mode
    print(f"\033[31m  No themes matching '{label}'\033[0m")
    if query:
        from difflib import get_close_matches
        all_names = [t["name"] for t in custom] + [t["name"] for t in themes]
        similar = get_close_matches(query, [n.lower() for n in all_names], n=5, cutoff=0.4)
        if similar:
            print(f"\n  \033[33mDid you mean:\033[0m")
            for s in similar:
                for t in custom + themes:
                    if t["name"].lower() == s:
                        print(f"    - {t['name']}")
                        break
    sys.exit(1)

print(f"\n  Found {len(matches)} theme(s):\n")
for t, is_custom in matches:
    name = t["name"]
    bg = t.get("background", "")
    fg = t.get("foreground", "")
    dark = is_dark(t)
    tag = "\033[2mdark\033[0m" if dark else "\033[33mlight\033[0m"
    prefix = "\033[35m*\033[0m " if is_custom else "  "
    # Highlight matching part
    highlighted = name
    if query:
        idx = name.lower().find(query)
        if idx >= 0:
            highlighted = name[:idx] + f"\033[1;33m{name[idx:idx+len(query)]}\033[0m" + name[idx+len(query):]
    # Show color swatches
    colors = ""
    for i in range(1, 9):
        c = t.get(f"color_{i:02d}", "")
        if c:
            r, g, b = int(c[1:3], 16), int(c[3:5], 16), int(c[5:7], 16)
            colors += f"\033[48;2;{r};{g};{b}m  \033[0m"
    print(f"{prefix}{highlighted}  [{tag}]  {colors}  \033[2mbg:{bg} fg:{fg}\033[0m")

print(f"\n  \033[2mUse: theme set \"<name>\" to apply\033[0m")
PYEOF
}

# --- Set theme by name ---
cmd_set() {
  local name="$1"
  if [[ -z "$name" ]]; then
    echo -e "${RED}Usage: theme set <theme-name>${RESET}"
    exit 1
  fi
  ensure_cache
  python3 << PYEOF
import json, sys, os

name = """${name}"""
themes = json.load(open("$GOGH_CACHE"))

# Load custom themes
custom = []
custom_path = "$CUSTOM_THEMES"
if os.path.exists(custom_path):
    custom = json.load(open(custom_path))

all_themes = custom + themes

# Exact match (case-insensitive) — custom themes checked first
match = None
for t in all_themes:
    if t["name"].lower() == name.lower():
        match = t
        break

# Partial match
if not match:
    partial = [t for t in all_themes if name.lower() in t["name"].lower()]
    if len(partial) == 1:
        match = partial[0]
    elif len(partial) > 1:
        print(f"\033[33m  Multiple matches for '{name}':\033[0m")
        for t in partial:
            custom_tag = " \033[35m(custom)\033[0m" if t in custom else ""
            print(f"    - {t['name']}{custom_tag}")
        print(f"\n  Be more specific.")
        sys.exit(1)

if not match:
    print(f"\033[31m  Theme '{name}' not found\033[0m")
    from difflib import get_close_matches
    all_names = [t["name"] for t in all_themes]
    similar = get_close_matches(name, all_names, n=5, cutoff=0.4)
    if not similar:
        similar = get_close_matches(name.lower(), [n.lower() for n in all_names], n=5, cutoff=0.3)
        if similar:
            similar = [n for n in all_names if n.lower() in similar]
    if similar:
        print(f"\n  \033[33mDid you mean:\033[0m")
        for s in similar:
            print(f"    - {s}")
    sys.exit(1)

is_custom = match in custom

# Extract colors
def strip(c):
    return c.lstrip('#').lower() if c else ''

def blend(c1, c2, ratio):
    """Blend c1 toward c2 by ratio (0.0=c1, 1.0=c2)"""
    r1, g1, b1 = int(c1[0:2], 16), int(c1[2:4], 16), int(c1[4:6], 16)
    r2, g2, b2 = int(c2[0:2], 16), int(c2[2:4], 16), int(c2[4:6], 16)
    r = int(r1 + (r2 - r1) * ratio)
    g = int(g1 + (g2 - g1) * ratio)
    b = int(b1 + (b2 - b1) * ratio)
    return f"{r:02x}{g:02x}{b:02x}"

bg = strip(match.get('background', ''))
fg = strip(match.get('foreground', ''))
cursor = strip(match.get('cursor', ''))

# color_01-08 = normal colors (black, red, green, yellow, blue, magenta, cyan, white)
# color_09-16 = bright colors
c = {}
for i in range(1, 17):
    c[i] = strip(match.get(f'color_{i:02d}', ''))

# Use extra fields from custom themes if available, otherwise derive via blending
bg_light = strip(match.get('bg_light', '')) or blend(bg, fg, 0.07)
bg_highlight = strip(match.get('bg_highlight', '')) or blend(bg, fg, 0.19)
fg_dim = strip(match.get('fg_dim', '')) or blend(fg, bg, 0.33)
fg_muted = strip(match.get('fg_muted', '')) or blend(fg, bg, 0.55)
border = strip(match.get('border', '')) or blend(bg, fg, 0.28)

source_label = "custom" if is_custom else "Gogh"
palette = f"""# Terminal color palette — single source of truth
# Theme: {match['name']} ({source_label})
# Edit this file, then run: theme sync

# Base colors
bg={bg}
bg_light={bg_light}
bg_highlight={bg_highlight}
fg={fg}
fg_dim={fg_dim}
fg_muted={fg_muted}
border={border}

# Terminal 16 colors
black={c[1]}
bright_black={c[9]}
red={c[2]}
bright_red={c[10]}
green={c[3]}
bright_green={c[11]}
yellow={c[4]}
bright_yellow={c[12]}
blue={c[5]}
bright_blue={c[13]}
magenta={c[6]}
bright_magenta={c[14]}
cyan={c[7]}
bright_cyan={c[15]}
white={c[8]}
bright_white={c[16]}

# Accent
cursor={cursor if cursor else c[5]}
url={c[5]}
"""

with open("$PALETTE", 'w') as f:
    f.write(palette)

source_tag = "\033[35m(custom)\033[0m" if is_custom else "\033[2m(Gogh)\033[0m"
print(f"\033[32m  Theme set: {match['name']}\033[0m {source_tag}")

# Show color preview
colors = ""
for i in range(1, 17):
    hex_c = match.get(f'color_{i:02d}', '#000000')
    r, g, b = int(hex_c[1:3], 16), int(hex_c[3:5], 16), int(hex_c[5:7], 16)
    colors += f"\033[48;2;{r};{g};{b}m  \033[0m"
    if i == 8:
        colors += " "
print(f"  {colors}")
print(f"  \033[2mbg:#{bg} fg:#{fg}\033[0m")
PYEOF

  if [[ $? -eq 0 ]]; then
    apply_palette
  fi
}

# --- Import theme (file, URL, or clipboard) ---
cmd_import() {
  local src="$1" label="clipboard"
  local tmpfile=""

  if [[ -z "$src" ]]; then
    # No arg — read from clipboard
    if ! command -v wl-paste &>/dev/null; then
      echo -e "${RED}wl-paste not found (install wl-clipboard)${RESET}"
      exit 1
    fi
    tmpfile=$(mktemp)
    wl-paste --no-newline > "$tmpfile" 2>/dev/null
    if [[ ! -s "$tmpfile" ]]; then
      rm -f "$tmpfile"
      echo -e "${RED}Clipboard is empty${RESET}"
      exit 1
    fi
    src="$tmpfile"
    echo -e "  ${DIM}Reading from clipboard...${RESET}"
  elif [[ "$src" == http* ]]; then
    label="$(basename "$src")"
    tmpfile=$(mktemp)
    echo -e "  ${DIM}Downloading...${RESET}"
    curl -sL "$src" -o "$tmpfile" || { echo -e "${RED}Download failed${RESET}"; exit 1; }
    src="$tmpfile"
  else
    label="$(basename "$src")"
    [[ ! -f "$src" ]] && { echo -e "${RED}File not found: $src${RESET}"; exit 1; }
  fi

  # Auto-detect: Xresources or kitty
  local is_xres=false
  if grep -qE '^\*\.?color[0-9]+:' "$src" 2>/dev/null; then
    is_xres=true
  fi

  local bg fg cursor sel_bg
  local c0 c1 c2 c3 c4 c5 c6 c7 c8 c9 c10 c11 c12 c13 c14 c15

  if $is_xres; then
    # Xresources: *.color0: #1a1b26  or  *color0: #1a1b26
    xget() { grep -iE '^\*\.?'"$1"':' "$src" | head -1 | grep -oP '#?\K[0-9a-fA-F]{6}' | head -1; }
    bg=$(xget "background"); fg=$(xget "foreground"); cursor=$(xget "cursorColor")
    c0=$(xget "color0"); c1=$(xget "color1"); c2=$(xget "color2"); c3=$(xget "color3")
    c4=$(xget "color4"); c5=$(xget "color5"); c6=$(xget "color6"); c7=$(xget "color7")
    c8=$(xget "color8"); c9=$(xget "color9"); c10=$(xget "color10"); c11=$(xget "color11")
    c12=$(xget "color12"); c13=$(xget "color13"); c14=$(xget "color14"); c15=$(xget "color15")
  else
    # Kitty: color0 #1a1b26
    get() { grep -iE "^$1\b" "$src" | head -1 | grep -oP '#?\K[0-9a-fA-F]{6}' | head -1; }
    bg=$(get "background"); fg=$(get "foreground"); cursor=$(get "cursor[^_]"); sel_bg=$(get "selection_background")
    c0=$(get "color0[^0-9]"); c1=$(get "color1[^0-9]"); c2=$(get "color2[^0-9]"); c3=$(get "color3[^0-9]")
    c4=$(get "color4[^0-9]"); c5=$(get "color5[^0-9]"); c6=$(get "color6[^0-9]"); c7=$(get "color7[^0-9]")
    c8=$(get "color8[^0-9]"); c9=$(get "color9[^0-9]"); c10=$(get "color10"); c11=$(get "color11")
    c12=$(get "color12"); c13=$(get "color13"); c14=$(get "color14"); c15=$(get "color15")
  fi

  [[ -z "$bg" || -z "$fg" ]] && { echo -e "${RED}Can't parse colors. Supported: kitty .conf, Xresources${RESET}"; rm -f "$tmpfile"; exit 1; }

  local fmt="kitty"; $is_xres && fmt="Xresources"

  cat > "$PALETTE" << EOF
# Terminal color palette — single source of truth
# Imported from: $label ($fmt)
# Edit this file, then run: theme sync

# Base colors
bg=$bg
bg_light=${c8:-$bg}
bg_highlight=${sel_bg:-${c8:-$bg}}
fg=$fg
fg_dim=${c7:-$fg}
fg_muted=${c8:-${c7:-71717a}}
border=${c8:-${c8:-$bg}}

# Terminal 16 colors
black=${c0:-$bg}
bright_black=${c8:-$bg}
red=${c1:-f7768e}
bright_red=${c9:-${c1:-f7768e}}
green=${c2:-9ece6a}
bright_green=${c10:-${c2:-9ece6a}}
yellow=${c3:-e0af68}
bright_yellow=${c11:-${c3:-e0af68}}
blue=${c4:-7aa2f7}
bright_blue=${c12:-${c4:-7aa2f7}}
magenta=${c5:-bb9af7}
bright_magenta=${c13:-${c5:-bb9af7}}
cyan=${c6:-7dcfff}
bright_cyan=${c14:-${c6:-7dcfff}}
white=${c7:-a1a1aa}
bright_white=${c15:-$fg}

# Accent
cursor=${cursor:-${c4:-7aa2f7}}
url=${c4:-7aa2f7}
EOF

  [[ -n "$tmpfile" ]] && rm -f "$tmpfile"
  echo -e "  ${GREEN}Imported${RESET} ${DIM}($fmt)${RESET}"
  apply_palette
}

# --- Show current theme ---
cmd_current() {
  if [[ ! -f "$PALETTE" ]]; then
    echo -e "  ${DIM}No palette set${RESET}"
    return 1
  fi
  local theme_name
  theme_name=$(grep -oP '# Theme: \K.*' "$PALETTE" 2>/dev/null || grep -oP '# Imported from: \K.*' "$PALETTE" 2>/dev/null || echo "custom")
  echo -e "  ${BOLD}$theme_name${RESET}"
  echo ""
  # Show colors from palette
  declare -A C
  while IFS='=' read -r key val; do
    [[ "$key" =~ ^#.*$ || -z "$key" ]] && continue
    key=$(echo "$key" | xargs); val=$(echo "$val" | xargs)
    [[ -n "$key" && -n "$val" ]] && C[$key]="$val"
  done < "$PALETTE"
  # Swatch
  for name in black red green yellow blue magenta cyan white; do
    hex="${C[$name]}"
    [[ -z "$hex" ]] && continue
    r=$((16#${hex:0:2})); g=$((16#${hex:2:2})); b=$((16#${hex:4:2}))
    printf "\033[48;2;%d;%d;%dm  \033[0m" "$r" "$g" "$b"
  done
  echo -n " "
  for name in bright_black bright_red bright_green bright_yellow bright_blue bright_magenta bright_cyan bright_white; do
    hex="${C[$name]}"
    [[ -z "$hex" ]] && continue
    r=$((16#${hex:0:2})); g=$((16#${hex:2:2})); b=$((16#${hex:4:2}))
    printf "\033[48;2;%d;%d;%dm  \033[0m" "$r" "$g" "$b"
  done
  echo ""
  echo -e "  ${DIM}bg:#${C[bg]} fg:#${C[fg]}${RESET}"
}

# --- Save current palette as custom theme ---
cmd_save() {
  local name="$1"
  [[ -z "$name" ]] && { echo -e "${RED}Usage: theme save <name>${RESET}"; exit 1; }
  [[ ! -f "$PALETTE" ]] && { echo -e "${RED}No palette set${RESET}"; exit 1; }

  python3 << PYEOF
import json, os

name = """${name}"""
palette_path = "$PALETTE"
custom_path = "$CUSTOM_THEMES"

# Read palette
C = {}
with open(palette_path) as f:
    for line in f:
        line = line.strip()
        if not line or line.startswith('#'): continue
        if '=' in line:
            k, v = line.split('=', 1)
            C[k.strip()] = v.strip()

# Build Gogh-format theme + extra palette fields
theme = {
    "name": name,
    "background": "#" + C.get("bg", "000000"),
    "foreground": "#" + C.get("fg", "ffffff"),
    "cursor": "#" + C.get("cursor", C.get("blue", "7aa2f7")),
    "color_01": "#" + C.get("black", "000000"),
    "color_02": "#" + C.get("red", "ff0000"),
    "color_03": "#" + C.get("green", "00ff00"),
    "color_04": "#" + C.get("yellow", "ffff00"),
    "color_05": "#" + C.get("blue", "0000ff"),
    "color_06": "#" + C.get("magenta", "ff00ff"),
    "color_07": "#" + C.get("cyan", "00ffff"),
    "color_08": "#" + C.get("white", "aaaaaa"),
    "color_09": "#" + C.get("bright_black", "555555"),
    "color_10": "#" + C.get("bright_red", "ff0000"),
    "color_11": "#" + C.get("bright_green", "00ff00"),
    "color_12": "#" + C.get("bright_yellow", "ffff00"),
    "color_13": "#" + C.get("bright_blue", "0000ff"),
    "color_14": "#" + C.get("bright_magenta", "ff00ff"),
    "color_15": "#" + C.get("bright_cyan", "00ffff"),
    "color_16": "#" + C.get("bright_white", "ffffff"),
    # Extra fields (not in Gogh, used for precise palette restoration)
    "bg_light": "#" + C.get("bg_light", ""),
    "bg_highlight": "#" + C.get("bg_highlight", ""),
    "fg_dim": "#" + C.get("fg_dim", ""),
    "fg_muted": "#" + C.get("fg_muted", ""),
    "border": "#" + C.get("border", ""),
}
# Remove empty extra fields
theme = {k: v for k, v in theme.items() if v != "#"}

# Load existing custom themes
themes = []
if os.path.exists(custom_path):
    with open(custom_path) as f:
        themes = json.load(f)

# Replace if name exists, otherwise append
replaced = False
for i, t in enumerate(themes):
    if t["name"].lower() == name.lower():
        themes[i] = theme
        replaced = True
        break
if not replaced:
    themes.append(theme)

with open(custom_path, 'w') as f:
    json.dump(themes, f, indent=2)

action = "updated" if replaced else "saved"
print(f"\033[32m  Theme '{name}' {action}\033[0m ({len(themes)} custom themes)")
PYEOF
}

# --- Remove custom theme ---
cmd_remove() {
  local name="$1"
  [[ -z "$name" ]] && { echo -e "${RED}Usage: theme remove <name>${RESET}"; exit 1; }
  [[ ! -f "$CUSTOM_THEMES" ]] && { echo -e "${RED}No custom themes${RESET}"; exit 1; }

  python3 << PYEOF
import json, sys

name = """${name}"""
custom_path = "$CUSTOM_THEMES"

with open(custom_path) as f:
    themes = json.load(f)

original = len(themes)
themes = [t for t in themes if t["name"].lower() != name.lower()]

if len(themes) == original:
    print(f"\033[31m  Theme '{name}' not found in custom themes\033[0m")
    if themes:
        print(f"\n  Custom themes:")
        for t in themes:
            print(f"    - {t['name']}")
    sys.exit(1)

with open(custom_path, 'w') as f:
    json.dump(themes, f, indent=2)

print(f"\033[32m  Theme '{name}' removed\033[0m ({len(themes)} custom themes)")
PYEOF
}

# --- Backup configs before first sync ---
ensure_backup() {
  [[ -d "$BACKUP_DIR" ]] && return
  mkdir -p "$BACKUP_DIR"
  local files=(
    "$HOME/.config/hypr/UserConfigs/monochrome-colors.conf"
    "$HOME/.config/hypr/wallust/wallust-hyprland.conf"
    "$HOME/.config/waybar/style-minimal.css"
    "$HOME/.config/rofi/themes/Monochrome-Dark.rasi"
    "$HOME/.config/swaync/style.css"
    "$HOME/.config/kitty/theme.conf"
    "$ANIMATIONS_CONF"
  )
  for f in "${files[@]}"; do
    [[ -f "$f" ]] && cp "$f" "$BACKUP_DIR/$(basename "$f").bak"
  done
  echo -e "    ${DIM}Backup saved to $BACKUP_DIR${RESET}"
}

cmd_backup() {
  rm -rf "$BACKUP_DIR"
  ensure_backup
  echo -e "${GREEN}  Backup created${RESET}"
}

# --- Animations toggle ---
cmd_animations() {
  local action="${1:-}"
  case "$action" in
    on)
      if [[ -f "$DEFAULT_ANIM" ]]; then
        cp "$DEFAULT_ANIM" "$ANIMATIONS_CONF"
      else
        cat > "$ANIMATIONS_CONF" << 'ANIMEOF'
animations {
  enabled = yes
  bezier = wind, 0.05, 0.9, 0.1, 1.05
  bezier = winIn, 0.1, 1.1, 0.1, 1.1
  bezier = winOut, 0.3, -0.3, 0, 1
  bezier = liner, 1, 1, 1, 1
  bezier = overshot, 0.05, 0.9, 0.1, 1.05
  bezier = smoothOut, 0.5, 0, 0.99, 0.99
  animation = windows, 1, 6, wind, slide
  animation = windowsIn, 1, 5, winIn, slide
  animation = windowsOut, 1, 3, smoothOut, slide
  animation = windowsMove, 1, 5, wind, slide
  animation = border, 1, 1, liner
  animation = fade, 1, 3, smoothOut
  animation = workspaces, 1, 5, overshot
}
ANIMEOF
      fi
      hyprctl reload &>/dev/null
      echo -e "  ${GREEN}Animations enabled${RESET}"
      ;;
    off)
      cat > "$ANIMATIONS_CONF" << 'ANIMEOF'
animations {
  enabled = no
}
ANIMEOF
      hyprctl reload &>/dev/null
      echo -e "  ${GREEN}Animations disabled${RESET}"
      ;;
    "")
      if grep -q "enabled = no" "$ANIMATIONS_CONF" 2>/dev/null; then
        echo -e "  Animations: ${RED}off${RESET}"
      else
        echo -e "  Animations: ${GREEN}on${RESET}"
      fi
      ;;
    *)
      echo -e "${RED}Usage: theme animations [on|off]${RESET}"
      exit 1
      ;;
  esac
}

# --- Apply palette to all configs ---
apply_palette() {
  if [[ ! -f "$PALETTE" ]]; then
    echo -e "${RED}Palette not found: $PALETTE${RESET}"
    exit 1
  fi

  declare -A C
  while IFS='=' read -r key val; do
    [[ "$key" =~ ^#.*$ || -z "$key" ]] && continue
    key=$(echo "$key" | xargs); val=$(echo "$val" | xargs)
    [[ -n "$key" && -n "$val" ]] && C[$key]="$val"
  done < "$PALETTE"

  ensure_backup
  echo "  Syncing..."

  # --- Kitty ---
  cat > "$HOME/.config/kitty/theme.conf" << EOF
# Auto-generated by theme sync from ~/.config/theme/palette.conf
background #${C[bg]}
foreground #${C[fg]}
cursor #${C[cursor]}
cursor_text_color #${C[bg]}
selection_background #${C[bg_highlight]}
selection_foreground #${C[fg]}
url_color #${C[url]}

active_tab_background #${C[bg_light]}
active_tab_foreground #${C[fg]}
inactive_tab_background #${C[bg]}
inactive_tab_foreground #${C[fg_muted]}

color0 #${C[black]}
color8 #${C[bright_black]}
color1 #${C[red]}
color9 #${C[bright_red]}
color2 #${C[green]}
color10 #${C[bright_green]}
color3 #${C[yellow]}
color11 #${C[bright_yellow]}
color4 #${C[blue]}
color12 #${C[bright_blue]}
color5 #${C[magenta]}
color13 #${C[bright_magenta]}
color6 #${C[cyan]}
color14 #${C[bright_cyan]}
color7 #${C[white]}
color15 #${C[bright_white]}
EOF
  echo -e "    ${GREEN}kitty${RESET}"

  # --- Neovim ---
  cat > "$HOME/.config/nvim/lua/plugins/colorscheme.lua" << EOF
-- Auto-generated by theme sync from ~/.config/theme/palette.conf
return {
  {
    "folke/tokyonight.nvim",
    lazy = false,
    priority = 1000,
    opts = {
      style = "night",
      transparent = false,
      terminal_colors = true,
      styles = {
        comments = { italic = false },
        keywords = { italic = false },
        sidebars = "dark",
        floats = "dark",
      },
      on_colors = function(colors)
        colors.bg = "#${C[bg]}"
        colors.bg_dark = "#${C[bg]}"
        colors.bg_float = "#${C[bg]}"
        colors.bg_popup = "#${C[bg]}"
        colors.bg_sidebar = "#${C[bg]}"
        colors.bg_statusline = "#${C[bg_light]}"
        colors.bg_highlight = "#${C[bg_light]}"
        colors.fg = "#${C[fg]}"
        colors.fg_dark = "#${C[fg_dim]}"
        colors.fg_gutter = "#${C[bg_highlight]}"
        colors.border = "#${C[bg_highlight]}"
        colors.comment = "#${C[fg_muted]}"
      end,
      on_highlights = function(hl, c)
        hl.Normal = { bg = "#${C[bg]}", fg = "#${C[fg]}" }
        hl.NormalNC = { bg = "#${C[bg]}", fg = "#${C[fg]}" }
        hl.NormalFloat = { bg = "#${C[bg]}" }
        hl.NormalSB = { bg = "#${C[bg]}" }
        hl.SignColumn = { bg = "#${C[bg]}" }
        hl.LineNr = { fg = "#${C[border]}", bg = "#${C[bg]}" }
        hl.CursorLineNr = { fg = "#${C[fg_dim]}", bg = "#${C[bg]}" }
        hl.CursorLine = { bg = "#${C[bg_light]}" }
        hl.Visual = { bg = "#${C[bg_highlight]}" }
        hl.Pmenu = { bg = "#${C[bg]}", fg = "#${C[fg]}" }
        hl.PmenuSel = { bg = "#${C[bg_highlight]}", fg = "#ffffff" }
        hl.NeoTreeNormal = { bg = "#${C[bg]}" }
        hl.NeoTreeNormalNC = { bg = "#${C[bg]}" }
        hl.NeoTreeEndOfBuffer = { bg = "#${C[bg]}" }
        hl.TelescopeNormal = { bg = "#${C[bg]}" }
        hl.TelescopeBorder = { bg = "#${C[bg]}", fg = "#${C[bg_highlight]}" }
        hl.StatusLine = { bg = "#${C[bg_light]}", fg = "#${C[fg]}" }
        hl.StatusLineNC = { bg = "#${C[bg]}", fg = "#${C[fg_muted]}" }
        hl.EndOfBuffer = { fg = "#${C[bg]}" }
      end,
    },
  },
  {
    "LazyVim/LazyVim",
    opts = {
      colorscheme = "tokyonight",
    },
  },
}
EOF
  echo -e "    ${GREEN}neovim${RESET}"

  # --- Zellij ---
  local ZELLIJ_CONF="$HOME/.config/zellij/config.kdl"
  if [[ -f "$ZELLIJ_CONF" ]]; then
    sed -i '/^\/\/ THEME-SYNC START/,/^\/\/ THEME-SYNC END/d' "$ZELLIJ_CONF"
    sed -i 's/^theme ".*"/theme "synced"/' "$ZELLIJ_CONF"
    cat >> "$ZELLIJ_CONF" << EOF
// THEME-SYNC START
themes {
  synced {
    bg "#${C[bg_light]}"
    fg "#${C[fg]}"
    black "#${C[black]}"
    red "#${C[red]}"
    green "#${C[green]}"
    yellow "#${C[yellow]}"
    blue "#${C[blue]}"
    magenta "#${C[magenta]}"
    cyan "#${C[cyan]}"
    white "#${C[white]}"
    orange "#${C[yellow]}"
  }
}
// THEME-SYNC END
EOF
    echo -e "    ${GREEN}zellij${RESET}"
  fi

  # --- Hyprland colors ---
  local hypr_colors
  hypr_colors="# Auto-generated by theme sync from ~/.config/theme/palette.conf
\$background = rgb(${C[bg]})
\$foreground = rgb(${C[fg]})
\$color0 = rgb(${C[black]})
\$color1 = rgb(${C[red]})
\$color2 = rgb(${C[green]})
\$color3 = rgb(${C[yellow]})
\$color4 = rgb(${C[blue]})
\$color5 = rgb(${C[magenta]})
\$color6 = rgb(${C[cyan]})
\$color7 = rgb(${C[white]})
\$color8 = rgb(${C[bright_black]})
\$color9 = rgb(${C[bright_red]})
\$color10 = rgb(${C[bright_green]})
\$color11 = rgb(${C[bright_yellow]})
\$color12 = rgb(${C[bright_blue]})
\$color13 = rgb(${C[bright_magenta]})
\$color14 = rgb(${C[bright_cyan]})
\$color15 = rgb(${C[bright_white]})"
  echo "$hypr_colors" > "$HOME/.config/hypr/UserConfigs/monochrome-colors.conf"
  echo "$hypr_colors" > "$HOME/.config/hypr/wallust/wallust-hyprland.conf"
  echo -e "    ${GREEN}hyprland${RESET}"

  # --- Waybar ---
  cat > "$HOME/.config/waybar/style-minimal.css" << EOF
/* Auto-generated by theme sync from ~/.config/theme/palette.conf */
/* Monochrome Minimal Waybar - R7 Style */

* {
  font-family: "JetBrainsMono Nerd Font", "NotoSans Nerd Font", sans-serif;
  font-size: 13px;
  font-weight: 500;
  min-height: 0;
  padding: 0;
}

#waybar {
  background: transparent;
  color: #${C[fg]};
  margin: 0;
  font-weight: 500;
}

/* --- All modules base style --- */
#workspaces,
#clock,
#tray,
#bluetooth,
#network,
#pulseaudio,
#backlight,
#battery,
#custom-power {
  background-color: #${C[bg]};
  padding: 0.25rem 0.6rem;
  margin: 3px 2px;
  border-radius: 4px;
  box-shadow: 0 1px 4px rgba(0, 0, 0, 0.3);
  transition: background-color 0.2s ease-in-out;
}

/* --- Workspaces --- */
#workspaces {
  padding: 0.15rem 0.3rem;
}

#workspaces button {
  color: #${C[fg_muted]};
  border-radius: 3px;
  padding: 0.2rem 0.4rem;
  margin: 0 1px;
  background: transparent;
  border: none;
  transition: all 0.2s ease-in-out;
}

#workspaces button.active {
  color: #${C[bg]};
  background-color: #${C[bright_white]};
}

#workspaces button:hover {
  background: #${C[bg_light]};
  color: #${C[fg]};
}

/* --- Clock --- */
#clock {
  color: #${C[bright_white]};
  font-weight: 600;
}

/* --- Right modules seamless bar --- */
#tray,
#bluetooth,
#network,
#pulseaudio,
#backlight,
#battery {
  border-radius: 0;
  margin: 3px 0;
  box-shadow: none;
}

#tray {
  border-top-left-radius: 4px;
  border-bottom-left-radius: 4px;
  margin-left: 2px;
}

#battery {
  border-top-right-radius: 4px;
  border-bottom-right-radius: 4px;
}

/* --- Focus Mode indicator --- */
#custom-focus {
  background-color: #${C[bg_light]};
  padding: 0.25rem 0.6rem 0.25rem 0.4rem;
  margin: 3px 2px;
  margin-right: 6px;
  border-radius: 4px;
  color: #${C[bright_white]};
  font-size: 14px;
  box-shadow: 0 1px 4px rgba(0, 0, 0, 0.3);
}

#custom-focus:hover {
  background-color: #${C[border]};
}

/* --- Language indicator --- */
#language {
  background-color: #${C[bg]};
  padding: 0.25rem 0.6rem;
  margin: 3px 2px;
  margin-right: 6px;
  border-radius: 4px;
  border: 1px solid #${C[border]};
  color: #${C[fg_dim]};
  font-weight: 600;
  box-shadow: 0 1px 4px rgba(0, 0, 0, 0.3);
}

#language:hover {
  background-color: #${C[bg_light]};
  color: #${C[bright_white]};
}

/* --- Power button separate --- */
#custom-power {
  margin-left: 3px;
  margin-right: 4px;
  color: #${C[fg_muted]};
}

#custom-power:hover {
  background-color: #${C[bg_light]};
  color: #${C[red]};
}

/* --- Hover effects --- */
#workspaces:hover,
#clock:hover,
#tray:hover,
#bluetooth:hover,
#network:hover,
#pulseaudio:hover,
#backlight:hover,
#battery:hover {
  background-color: #${C[bg_light]};
}

/* --- Module colors --- */
#bluetooth {
  color: #${C[fg_muted]};
  font-size: 15px;
}

#bluetooth.connected {
  color: #${C[bright_white]};
}

#network {
  color: #${C[fg_dim]};
}

#network.disconnected {
  color: #${C[red]};
}

#pulseaudio {
  color: #${C[fg]};
}

#pulseaudio.muted {
  color: #${C[fg_muted]};
}

#backlight {
  color: #${C[fg_dim]};
}

#battery {
  color: #${C[fg]};
}

#battery.charging {
  color: #${C[fg_dim]};
}

#battery.warning:not(.charging) {
  color: #${C[red]};
}

#battery.critical:not(.charging) {
  color: #${C[red]};
  animation: blink 0.5s steps(12) infinite alternate;
}

@keyframes blink {
  to { color: #${C[bg]}; }
}

/* --- Tooltip --- */
tooltip {
  background-color: #${C[bg]};
  color: #${C[fg]};
  padding: 8px 14px;
  border-radius: 8px;
  border: 1px solid #${C[border]};
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
}

tooltip label {
  color: #${C[fg]};
}
EOF
  echo -e "    ${GREEN}waybar${RESET}"

  # --- Rofi ---
  local ROFI_THEME="$HOME/.config/rofi/themes/Monochrome-Dark.rasi"
  if [[ -f "$ROFI_THEME" ]]; then
    sed -i \
      -e 's/^\(    background: *\)#[0-9a-fA-F]\{6\}/\1#'"${C[bg]}"'/' \
      -e 's/^\(    background-alt: *\)#[0-9a-fA-F]\{6\}/\1#'"${C[bg_light]}"'/' \
      -e 's/^\(    foreground: *\)#[0-9a-fA-F]\{6\}/\1#'"${C[fg]}"'/' \
      -e 's/^\(    selected: *\)#[0-9a-fA-F]\{6\}/\1#'"${C[bright_white]}"'/' \
      -e 's/^\(    active: *\)#[0-9a-fA-F]\{6\}/\1#'"${C[fg_dim]}"'/' \
      -e 's/^\(    urgent: *\)#[0-9a-fA-F]\{6\}/\1#'"${C[red]}"'/' \
      -e 's/^\(    border-dim: *\)#[0-9a-fA-F]\{6\}/\1#'"${C[border]}"'/' \
      -e 's/^\(    text-dim: *\)#[0-9a-fA-F]\{6\}/\1#'"${C[fg_muted]}"'/' \
      "$ROFI_THEME"
    echo -e "    ${GREEN}rofi${RESET}"
  fi

  # --- SwayNC ---
  local SWAYNC_STYLE="$HOME/.config/swaync/style.css"
  if [[ -f "$SWAYNC_STYLE" ]]; then
    sed -i \
      -e 's/@define-color noti-border-color #[0-9a-fA-F]\{6\}/@define-color noti-border-color #'"${C[border]}"'/' \
      -e 's/@define-color noti-bg #[0-9a-fA-F]\{6\}/@define-color noti-bg #'"${C[bg]}"'/' \
      -e 's/@define-color noti-bg-alt #[0-9a-fA-F]\{6\}/@define-color noti-bg-alt #'"${C[bg_light]}"'/' \
      -e 's/@define-color noti-bg-hover #[0-9a-fA-F]\{6\}/@define-color noti-bg-hover #'"${C[bg_light]}"'/' \
      -e 's/@define-color text-color #[0-9a-fA-F]\{6\}/@define-color text-color #'"${C[fg]}"'/' \
      -e 's/@define-color accent #[0-9a-fA-F]\{6\}/@define-color accent #'"${C[bright_white]}"'/' \
      -e 's/@define-color text-dim #[0-9a-fA-F]\{6\}/@define-color text-dim #'"${C[fg_muted]}"'/' \
      -e 's/@define-color urgent #[0-9a-fA-F]\{6\}/@define-color urgent #'"${C[red]}"'/' \
      "$SWAYNC_STYLE"
    echo -e "    ${GREEN}swaync${RESET}"
  fi

  # --- Reload all ---
  if pgrep -x kitty &>/dev/null; then
    kill -SIGUSR1 $(pgrep -x kitty) 2>/dev/null
    echo -e "    ${GREEN}kitty reloaded${RESET}"
  fi
  if pgrep -x Hyprland &>/dev/null; then
    hyprctl reload &>/dev/null
    echo -e "    ${GREEN}hyprland reloaded${RESET}"
  fi
  if pgrep -x waybar &>/dev/null; then
    pkill waybar
    sleep 0.3
    waybar &>/dev/null & disown
    echo -e "    ${GREEN}waybar restarted${RESET}"
  fi
  if pgrep -x swaync &>/dev/null; then
    swaync-client -rs &>/dev/null
    echo -e "    ${GREEN}swaync reloaded${RESET}"
  fi

  echo -e "  ${BOLD}Done!${RESET} Restart neovim and zellij to apply."
}

# --- Help ---
cmd_help() {
  echo ""
  echo -e "  ${BOLD}Commands:${RESET}"
  echo ""
  echo -e "    theme set ${DIM}<name>${RESET}              set Gogh theme (364 themes)"
  echo -e "    theme search ${DIM}<q>${RESET}             search themes (fuzzy + color preview)"
  echo -e "    theme search ${DIM}<q>${RESET} --dark      search only dark themes"
  echo -e "    theme search ${DIM}<q>${RESET} --light     search only light themes"
  echo -e "    theme dark ${DIM}[query]${RESET}           browse/search dark themes"
  echo -e "    theme light ${DIM}[query]${RESET}          browse/search light themes"
  echo -e "    theme list ${DIM}[dark|light]${RESET}      list all themes (or filtered)"
  echo -e "    theme save ${DIM}<name>${RESET}             save current palette as custom theme"
  echo -e "    theme remove ${DIM}<name>${RESET}           remove custom theme"
  echo -e "    theme sync                   apply palette to all desktop configs"
  echo -e "    theme import ${DIM}[file|url]${RESET}      import theme (kitty/Xresources, or clipboard)"
  echo -e "    theme update                 refresh Gogh themes cache"
  echo -e "    theme current                show current theme details"
  echo -e "    theme animations ${DIM}[on|off]${RESET}   toggle Hyprland animations"
  echo -e "    theme backup                 backup all configs"
  echo ""
  echo -e "  ${DIM}Palette: ~/.config/theme/palette.conf${RESET}"
}

# --- Default: show current theme + help ---
cmd_default() {
  echo ""
  cmd_current
  cmd_help
  echo ""
}

# --- Main ---
case "${1:-}" in
  set)     cmd_set "$2" ;;
  search)  shift; cmd_search "$@" ;;
  list)    cmd_list "$2" ;;
  dark)       cmd_search --dark "$2" ;;
  light)      cmd_search --light "$2" ;;
  save)       cmd_save "$2" ;;
  remove)     cmd_remove "$2" ;;
  sync)       apply_palette ;;
  import)     cmd_import "$2" ;;
  update)     cmd_update ;;
  current)    cmd_current ;;
  animations) cmd_animations "$2" ;;
  backup)     cmd_backup ;;
  help|-h|--help) cmd_default ;;
  "")      cmd_default ;;
  *)
    echo -e "${RED}Unknown command: $1${RESET}"
    echo "Run 'theme' for usage"
    exit 1
    ;;
esac
