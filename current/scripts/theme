#!/usr/bin/env bash
# theme — unified color management for kitty, neovim, zellij
# Usage:
#   theme                       — show current theme + help
#   theme sync                  — apply palette to all configs
#   theme set <name>            — set Gogh theme by name
#   theme search <query>        — search Gogh themes (fuzzy)
#   theme list                  — list all Gogh themes
#   theme import <file|url>     — import kitty theme file
#   theme update                — update Gogh themes cache
#   theme current               — show current palette

PALETTE="$HOME/.config/theme/palette.conf"
GOGH_CACHE="$HOME/.config/theme/gogh-themes.json"
GOGH_URL="https://raw.githubusercontent.com/Gogh-Co/Gogh/master/data/themes.json"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
BOLD='\033[1m'
DIM='\033[2m'
RESET='\033[0m'

# --- Ensure Gogh cache exists ---
ensure_cache() {
  if [[ ! -f "$GOGH_CACHE" ]]; then
    echo -e "${DIM}Downloading Gogh themes...${RESET}"
    mkdir -p "$(dirname "$GOGH_CACHE")"
    curl -sL "$GOGH_URL" -o "$GOGH_CACHE" || { echo -e "${RED}Download failed${RESET}"; exit 1; }
    local count
    count=$(python3 -c "import json; print(len(json.load(open('$GOGH_CACHE'))))" 2>/dev/null)
    echo -e "${GREEN}Cached $count themes${RESET}"
  fi
}

# --- Update cache ---
cmd_update() {
  echo "Updating Gogh themes cache..."
  rm -f "$GOGH_CACHE"
  ensure_cache
}

# --- List all themes ---
cmd_list() {
  local filter="${1:-}"
  ensure_cache
  python3 << PYEOF
import json

def luminance(hex_color):
    hex_color = hex_color.lstrip('#')
    if len(hex_color) != 6: return 128
    r, g, b = int(hex_color[0:2], 16), int(hex_color[2:4], 16), int(hex_color[4:6], 16)
    return 0.299 * r + 0.587 * g + 0.114 * b

def is_dark(t):
    return luminance(t.get('background', '#808080')) < 128

filter_mode = "${filter}".lower()
themes = json.load(open("$GOGH_CACHE"))
shown = 0

for i, t in enumerate(themes, 1):
    dark = is_dark(t)
    if filter_mode == "dark" and not dark: continue
    if filter_mode == "light" and dark: continue
    bg = t.get('background', '')
    tag = "\033[2mdark\033[0m" if dark else "\033[33mlight\033[0m"
    print(f'  {i:3d}. {t["name"]}  [{tag}]  \033[2m{bg}\033[0m')
    shown += 1

label = f" ({filter_mode})" if filter_mode in ("dark", "light") else ""
print(f'\n  Total: {shown} themes{label}')
PYEOF
}

# --- Search themes ---
cmd_search() {
  # Parse --dark/--light flags
  local filter="" query=""
  for arg in "$@"; do
    case "$arg" in
      --dark)  filter="dark" ;;
      --light) filter="light" ;;
      *)       query="$arg" ;;
    esac
  done
  if [[ -z "$query" && -z "$filter" ]]; then
    echo -e "${RED}Usage: theme search <query> [--dark|--light]${RESET}"
    exit 1
  fi
  ensure_cache
  python3 << PYEOF
import json, sys

def luminance(hex_color):
    hex_color = hex_color.lstrip('#')
    if len(hex_color) != 6: return 128
    r, g, b = int(hex_color[0:2], 16), int(hex_color[2:4], 16), int(hex_color[4:6], 16)
    return 0.299 * r + 0.587 * g + 0.114 * b

def is_dark(t):
    return luminance(t.get('background', '#808080')) < 128

query = """${query}""".lower()
filter_mode = "${filter}"
themes = json.load(open("$GOGH_CACHE"))
matches = []

for t in themes:
    # Apply dark/light filter
    dark = is_dark(t)
    if filter_mode == "dark" and not dark: continue
    if filter_mode == "light" and dark: continue
    # Apply name filter (if query given)
    if query and query not in t["name"].lower(): continue
    matches.append(t)

if not matches:
    label = query or filter_mode
    print(f"\033[31m  No themes matching '{label}'\033[0m")
    if query:
        from difflib import get_close_matches
        names = [t["name"] for t in themes]
        similar = get_close_matches(query, [n.lower() for n in names], n=5, cutoff=0.4)
        if similar:
            print(f"\n  \033[33mDid you mean:\033[0m")
            for s in similar:
                for t in themes:
                    if t["name"].lower() == s:
                        print(f"    - {t['name']}")
                        break
    sys.exit(1)

print(f"\n  Found {len(matches)} theme(s):\n")
for t in matches:
    name = t["name"]
    bg = t.get("background", "")
    fg = t.get("foreground", "")
    dark = is_dark(t)
    tag = "\033[2mdark\033[0m" if dark else "\033[33mlight\033[0m"
    # Highlight matching part
    highlighted = name
    if query:
        idx = name.lower().find(query)
        if idx >= 0:
            highlighted = name[:idx] + f"\033[1;33m{name[idx:idx+len(query)]}\033[0m" + name[idx+len(query):]
    # Show color swatches
    colors = ""
    for i in range(1, 9):
        c = t.get(f"color_{i:02d}", "")
        if c:
            r, g, b = int(c[1:3], 16), int(c[3:5], 16), int(c[5:7], 16)
            colors += f"\033[48;2;{r};{g};{b}m  \033[0m"
    print(f"  {highlighted}  [{tag}]  {colors}  \033[2mbg:{bg} fg:{fg}\033[0m")

print(f"\n  \033[2mUse: theme set \"<name>\" to apply\033[0m")
PYEOF
}

# --- Set theme by name ---
cmd_set() {
  local name="$1"
  if [[ -z "$name" ]]; then
    echo -e "${RED}Usage: theme set <theme-name>${RESET}"
    exit 1
  fi
  ensure_cache
  python3 << PYEOF
import json, sys

name = """${name}"""
themes = json.load(open("$GOGH_CACHE"))

# Exact match (case-insensitive)
match = None
for t in themes:
    if t["name"].lower() == name.lower():
        match = t
        break

# Partial match
if not match:
    partial = [t for t in themes if name.lower() in t["name"].lower()]
    if len(partial) == 1:
        match = partial[0]
    elif len(partial) > 1:
        print(f"\033[33m  Multiple matches for '{name}':\033[0m")
        for t in partial:
            print(f"    - {t['name']}")
        print(f"\n  Be more specific.")
        sys.exit(1)

if not match:
    print(f"\033[31m  Theme '{name}' not found\033[0m")
    from difflib import get_close_matches
    names = [t["name"] for t in themes]
    similar = get_close_matches(name, names, n=5, cutoff=0.4)
    if not similar:
        similar = get_close_matches(name.lower(), [n.lower() for n in names], n=5, cutoff=0.3)
        if similar:
            similar = [n for n in names if n.lower() in similar]
    if similar:
        print(f"\n  \033[33mDid you mean:\033[0m")
        for s in similar:
            print(f"    - {s}")
    sys.exit(1)

# Extract colors
def strip(c):
    return c.lstrip('#').lower() if c else ''

bg = strip(match.get('background', ''))
fg = strip(match.get('foreground', ''))
cursor = strip(match.get('cursor', ''))

# color_01-08 = normal colors (black, red, green, yellow, blue, magenta, cyan, white)
# color_09-16 = bright colors
c = {}
for i in range(1, 17):
    c[i] = strip(match.get(f'color_{i:02d}', ''))

# Derive base colors
bg_light = c[9] if c[9] else bg     # bright black
bg_highlight = c[9] if c[9] else bg  # selection
fg_dim = c[8] if c[8] else fg        # white (normal)
fg_muted = c[9] if c[9] else c[8]    # bright black or white
border = c[9] if c[9] else bg_light

palette = f"""# Terminal color palette — single source of truth
# Theme: {match['name']} (Gogh)
# Edit this file, then run: theme sync

# Base colors
bg={bg}
bg_light={bg_light}
bg_highlight={bg_highlight}
fg={fg}
fg_dim={fg_dim}
fg_muted={fg_muted}
border={border}

# Terminal 16 colors
black={c[1]}
bright_black={c[9]}
red={c[2]}
bright_red={c[10]}
green={c[3]}
bright_green={c[11]}
yellow={c[4]}
bright_yellow={c[12]}
blue={c[5]}
bright_blue={c[13]}
magenta={c[6]}
bright_magenta={c[14]}
cyan={c[7]}
bright_cyan={c[15]}
white={c[8]}
bright_white={c[16]}

# Accent
cursor={cursor if cursor else c[5]}
url={c[5]}
"""

with open("$PALETTE", 'w') as f:
    f.write(palette)

print(f"\033[32m  Theme set: {match['name']}\033[0m")

# Show color preview
colors = ""
for i in range(1, 17):
    hex_c = match.get(f'color_{i:02d}', '#000000')
    r, g, b = int(hex_c[1:3], 16), int(hex_c[3:5], 16), int(hex_c[5:7], 16)
    colors += f"\033[48;2;{r};{g};{b}m  \033[0m"
    if i == 8:
        colors += " "
print(f"  {colors}")
print(f"  \033[2mbg:#{bg} fg:#{fg}\033[0m")
PYEOF

  if [[ $? -eq 0 ]]; then
    apply_palette
  fi
}

# --- Import kitty theme file ---
cmd_import() {
  local src="$1"
  [[ -z "$src" ]] && { echo -e "${RED}Usage: theme import <file|url>${RESET}"; exit 1; }

  local tmpfile=""
  if [[ "$src" == http* ]]; then
    tmpfile=$(mktemp)
    echo "Downloading..."
    curl -sL "$src" -o "$tmpfile" || { echo "Download failed"; exit 1; }
    src="$tmpfile"
  fi

  [[ ! -f "$src" ]] && { echo "File not found: $src"; exit 1; }

  get() { grep -iE "^$1\b" "$src" | head -1 | grep -oP '#?\K[0-9a-fA-F]{6}' | head -1; }

  local bg fg cursor sel_bg
  bg=$(get "background"); fg=$(get "foreground"); cursor=$(get "cursor[^_]"); sel_bg=$(get "selection_background")

  local c0 c1 c2 c3 c4 c5 c6 c7 c8 c9 c10 c11 c12 c13 c14 c15
  c0=$(get "color0[^0-9]"); c1=$(get "color1[^0-9]"); c2=$(get "color2[^0-9]"); c3=$(get "color3[^0-9]")
  c4=$(get "color4[^0-9]"); c5=$(get "color5[^0-9]"); c6=$(get "color6[^0-9]"); c7=$(get "color7[^0-9]")
  c8=$(get "color8[^0-9]"); c9=$(get "color9[^0-9]"); c10=$(get "color10"); c11=$(get "color11")
  c12=$(get "color12"); c13=$(get "color13"); c14=$(get "color14"); c15=$(get "color15")

  [[ -z "$bg" || -z "$fg" ]] && { echo "Error: can't parse background/foreground"; exit 1; }

  cat > "$PALETTE" << EOF
# Terminal color palette — single source of truth
# Imported from: $(basename "$1")
# Edit this file, then run: theme sync

# Base colors
bg=$bg
bg_light=${c8:-$bg}
bg_highlight=${sel_bg:-${c8:-$bg}}
fg=$fg
fg_dim=${c7:-$fg}
fg_muted=${c8:-${c7:-71717a}}
border=${c8:-${c8:-$bg}}

# Terminal 16 colors
black=${c0:-$bg}
bright_black=${c8:-$bg}
red=${c1:-f7768e}
bright_red=${c9:-${c1:-f7768e}}
green=${c2:-9ece6a}
bright_green=${c10:-${c2:-9ece6a}}
yellow=${c3:-e0af68}
bright_yellow=${c11:-${c3:-e0af68}}
blue=${c4:-7aa2f7}
bright_blue=${c12:-${c4:-7aa2f7}}
magenta=${c5:-bb9af7}
bright_magenta=${c13:-${c5:-bb9af7}}
cyan=${c6:-7dcfff}
bright_cyan=${c14:-${c6:-7dcfff}}
white=${c7:-a1a1aa}
bright_white=${c15:-$fg}

# Accent
cursor=${cursor:-${c4:-7aa2f7}}
url=${c4:-7aa2f7}
EOF

  [[ -n "$tmpfile" ]] && rm -f "$tmpfile"
  echo -e "${GREEN}  Palette imported${RESET}"
  apply_palette
}

# --- Show current theme ---
cmd_current() {
  if [[ ! -f "$PALETTE" ]]; then
    echo -e "  ${DIM}No palette set${RESET}"
    return 1
  fi
  local theme_name
  theme_name=$(grep -oP '# Theme: \K.*' "$PALETTE" 2>/dev/null || grep -oP '# Imported from: \K.*' "$PALETTE" 2>/dev/null || echo "custom")
  echo -e "  ${BOLD}$theme_name${RESET}"
  echo ""
  # Show colors from palette
  declare -A C
  while IFS='=' read -r key val; do
    [[ "$key" =~ ^#.*$ || -z "$key" ]] && continue
    key=$(echo "$key" | xargs); val=$(echo "$val" | xargs)
    [[ -n "$key" && -n "$val" ]] && C[$key]="$val"
  done < "$PALETTE"
  # Swatch
  for name in black red green yellow blue magenta cyan white; do
    hex="${C[$name]}"
    [[ -z "$hex" ]] && continue
    r=$((16#${hex:0:2})); g=$((16#${hex:2:2})); b=$((16#${hex:4:2}))
    printf "\033[48;2;%d;%d;%dm  \033[0m" "$r" "$g" "$b"
  done
  echo -n " "
  for name in bright_black bright_red bright_green bright_yellow bright_blue bright_magenta bright_cyan bright_white; do
    hex="${C[$name]}"
    [[ -z "$hex" ]] && continue
    r=$((16#${hex:0:2})); g=$((16#${hex:2:2})); b=$((16#${hex:4:2}))
    printf "\033[48;2;%d;%d;%dm  \033[0m" "$r" "$g" "$b"
  done
  echo ""
  echo -e "  ${DIM}bg:#${C[bg]} fg:#${C[fg]}${RESET}"
}

# --- Apply palette to all configs ---
apply_palette() {
  if [[ ! -f "$PALETTE" ]]; then
    echo -e "${RED}Palette not found: $PALETTE${RESET}"
    exit 1
  fi

  declare -A C
  while IFS='=' read -r key val; do
    [[ "$key" =~ ^#.*$ || -z "$key" ]] && continue
    key=$(echo "$key" | xargs); val=$(echo "$val" | xargs)
    [[ -n "$key" && -n "$val" ]] && C[$key]="$val"
  done < "$PALETTE"

  echo "  Syncing..."

  # --- Kitty ---
  cat > "$HOME/.config/kitty/theme.conf" << EOF
# Auto-generated by theme sync from ~/.config/theme/palette.conf
background #${C[bg]}
foreground #${C[fg]}
cursor #${C[cursor]}
cursor_text_color #${C[bg]}
selection_background #${C[bg_highlight]}
selection_foreground #${C[fg]}
url_color #${C[url]}

active_tab_background #${C[bg_light]}
active_tab_foreground #${C[fg]}
inactive_tab_background #${C[bg]}
inactive_tab_foreground #${C[fg_muted]}

color0 #${C[black]}
color8 #${C[bright_black]}
color1 #${C[red]}
color9 #${C[bright_red]}
color2 #${C[green]}
color10 #${C[bright_green]}
color3 #${C[yellow]}
color11 #${C[bright_yellow]}
color4 #${C[blue]}
color12 #${C[bright_blue]}
color5 #${C[magenta]}
color13 #${C[bright_magenta]}
color6 #${C[cyan]}
color14 #${C[bright_cyan]}
color7 #${C[white]}
color15 #${C[bright_white]}
EOF
  echo -e "    ${GREEN}kitty${RESET}"

  # --- Neovim ---
  cat > "$HOME/.config/nvim/lua/plugins/colorscheme.lua" << EOF
-- Auto-generated by theme sync from ~/.config/theme/palette.conf
return {
  {
    "folke/tokyonight.nvim",
    lazy = false,
    priority = 1000,
    opts = {
      style = "night",
      transparent = false,
      terminal_colors = true,
      styles = {
        comments = { italic = false },
        keywords = { italic = false },
        sidebars = "dark",
        floats = "dark",
      },
      on_colors = function(colors)
        colors.bg = "#${C[bg]}"
        colors.bg_dark = "#${C[bg]}"
        colors.bg_float = "#${C[bg]}"
        colors.bg_popup = "#${C[bg]}"
        colors.bg_sidebar = "#${C[bg]}"
        colors.bg_statusline = "#${C[bg_light]}"
        colors.bg_highlight = "#${C[bg_light]}"
        colors.fg = "#${C[fg]}"
        colors.fg_dark = "#${C[fg_dim]}"
        colors.fg_gutter = "#${C[bg_highlight]}"
        colors.border = "#${C[bg_highlight]}"
        colors.comment = "#${C[fg_muted]}"
      end,
      on_highlights = function(hl, c)
        hl.Normal = { bg = "#${C[bg]}", fg = "#${C[fg]}" }
        hl.NormalNC = { bg = "#${C[bg]}", fg = "#${C[fg]}" }
        hl.NormalFloat = { bg = "#${C[bg]}" }
        hl.NormalSB = { bg = "#${C[bg]}" }
        hl.SignColumn = { bg = "#${C[bg]}" }
        hl.LineNr = { fg = "#${C[border]}", bg = "#${C[bg]}" }
        hl.CursorLineNr = { fg = "#${C[fg_dim]}", bg = "#${C[bg]}" }
        hl.CursorLine = { bg = "#${C[bg_light]}" }
        hl.Visual = { bg = "#${C[bg_highlight]}" }
        hl.Pmenu = { bg = "#${C[bg]}", fg = "#${C[fg]}" }
        hl.PmenuSel = { bg = "#${C[bg_highlight]}", fg = "#ffffff" }
        hl.NeoTreeNormal = { bg = "#${C[bg]}" }
        hl.NeoTreeNormalNC = { bg = "#${C[bg]}" }
        hl.NeoTreeEndOfBuffer = { bg = "#${C[bg]}" }
        hl.TelescopeNormal = { bg = "#${C[bg]}" }
        hl.TelescopeBorder = { bg = "#${C[bg]}", fg = "#${C[bg_highlight]}" }
        hl.StatusLine = { bg = "#${C[bg_light]}", fg = "#${C[fg]}" }
        hl.StatusLineNC = { bg = "#${C[bg]}", fg = "#${C[fg_muted]}" }
        hl.EndOfBuffer = { fg = "#${C[bg]}" }
      end,
    },
  },
  {
    "LazyVim/LazyVim",
    opts = {
      colorscheme = "tokyonight",
    },
  },
}
EOF
  echo -e "    ${GREEN}neovim${RESET}"

  # --- Zellij ---
  local ZELLIJ_CONF="$HOME/.config/zellij/config.kdl"
  if [[ -f "$ZELLIJ_CONF" ]]; then
    sed -i '/^\/\/ THEME-SYNC START/,/^\/\/ THEME-SYNC END/d' "$ZELLIJ_CONF"
    sed -i 's/^theme ".*"/theme "synced"/' "$ZELLIJ_CONF"
    cat >> "$ZELLIJ_CONF" << EOF
// THEME-SYNC START
themes {
  synced {
    bg "#${C[bg_light]}"
    fg "#${C[fg]}"
    black "#${C[black]}"
    red "#${C[red]}"
    green "#${C[green]}"
    yellow "#${C[yellow]}"
    blue "#${C[blue]}"
    magenta "#${C[magenta]}"
    cyan "#${C[cyan]}"
    white "#${C[white]}"
    orange "#${C[yellow]}"
  }
}
// THEME-SYNC END
EOF
    echo -e "    ${GREEN}zellij${RESET}"
  fi

  # Reload kitty
  if pgrep -x kitty &>/dev/null; then
    kill -SIGUSR1 $(pgrep -x kitty) 2>/dev/null
    echo -e "    ${GREEN}kitty reloaded${RESET}"
  fi

  echo -e "  ${BOLD}Done!${RESET} Restart neovim and zellij to apply."
}

# --- Help ---
cmd_help() {
  echo ""
  echo -e "  ${BOLD}Commands:${RESET}"
  echo ""
  echo -e "    theme set ${DIM}<name>${RESET}              set Gogh theme (364 themes)"
  echo -e "    theme search ${DIM}<q>${RESET}             search themes (fuzzy + color preview)"
  echo -e "    theme search ${DIM}<q>${RESET} --dark      search only dark themes"
  echo -e "    theme search ${DIM}<q>${RESET} --light     search only light themes"
  echo -e "    theme dark ${DIM}[query]${RESET}           browse/search dark themes"
  echo -e "    theme light ${DIM}[query]${RESET}          browse/search light themes"
  echo -e "    theme list ${DIM}[dark|light]${RESET}      list all themes (or filtered)"
  echo -e "    theme sync                   apply palette to kitty/neovim/zellij"
  echo -e "    theme import ${DIM}<file>${RESET}          import kitty theme file or URL"
  echo -e "    theme update                 refresh Gogh themes cache"
  echo -e "    theme current                show current theme details"
  echo ""
  echo -e "  ${DIM}Palette: ~/.config/theme/palette.conf${RESET}"
}

# --- Default: show current theme + help ---
cmd_default() {
  echo ""
  cmd_current
  cmd_help
  echo ""
}

# --- Main ---
case "${1:-}" in
  set)     cmd_set "$2" ;;
  search)  shift; cmd_search "$@" ;;
  list)    cmd_list "$2" ;;
  dark)    cmd_search --dark "$2" ;;
  light)   cmd_search --light "$2" ;;
  sync)    apply_palette ;;
  import)  cmd_import "$2" ;;
  update)  cmd_update ;;
  current) cmd_current ;;
  help|-h|--help) cmd_default ;;
  "")      cmd_default ;;
  *)
    echo -e "${RED}Unknown command: $1${RESET}"
    echo "Run 'theme' for usage"
    exit 1
    ;;
esac
